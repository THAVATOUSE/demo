<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>智农通农产品平台 - 无人机配送管理系统</title>
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script type="text/javascript"
            src="https://api.map.baidu.com/api?v=1.0&type=webgl&ak=ISpoPMZMpwaFeW2K1diXqeGAvvMgB3BY"></script>
    <!-- 引入Element UI样式 -->
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <!-- 假设CSS文件在本地或通过服务器提供，为了确保预览效果，部分关键样式已内联 -->
    <link rel="stylesheet" href="/static/css/home-mamagement-style.css" />

    <style>
        /* 新增：地图图例样式 */
        .map-legend {
            position: absolute;
            bottom: 30px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.15);
            z-index: 999;
            font-family: 'PingFang SC', 'Microsoft YaHei';
            width: 160px;
        }

        .map-legend h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
            color: #666;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .color-box {
            width: 16px;
            height: 16px;
            border-radius: 3px;
            margin-right: 8px;
            border: 1px solid rgba(0,0,0,0.1);
        }

        /* 修复 Element UI 图标显示问题 (如果 CDN 加载缓慢) */
        [class^="el-icon-"], [class*=" el-icon-"] {
            font-family: element-icons !important;
        }

        /* 确保地图容器占满 */
        #container {
            width: 100%;
            height: 100%;
        }

        /* 动画关键帧 - 保持原有样式 */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 152, 0, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 152, 0, 0); }
        }
    </style>

</head>

<body>
<div id="app">
    <header>
        <div class="header-container">
            <div class="logo-container">
                <div class="logo">
                    <i class="fas fa-leaf"></i>
                </div>
                <h1 class="platform-name">智农通农产品交易平台</h1>
            </div>

            <div class="search-container">
                <div class="search-box">
                    <input type="text" placeholder="搜索订单、无人机或农产品...">
                    <button><i class="fas fa-search"></i> 搜索</button>
                </div>
            </div>

            <div class="user-actions">
                <el-button icon="el-icon-bell" circle></el-button>
                <el-button icon="el-icon-setting" circle></el-button>
                <el-button icon="el-icon-user">管理员</el-button>
            </div>
        </div>
    </header>

    <main>
        <el-container style="height: 100%;">
            <!-- 侧边栏-功能模块 -->
            <el-aside width="280px">
                <el-menu :default-active="activeIndex" :default-openeds="['1', '2', '3', '4', '5']"
                         @select="handleMenuSelect" @open="handleOpen" @close="handleClose" active-text-color="#2e7d32">
                    <el-submenu index="1">
                        <template slot="title">
                            <i class="fas fa-tasks"></i>
                            <span><b>订单接收与分配</b></span>
                        </template>
                        <el-menu-item index="1-1">
                            <el-popover placement="right" width="400" trigger="click">
                                <div class="section-title">
                                    <i class="fas fa-shopping-cart"></i>
                                    接受消费者订单
                                </div>
                                <div class="card-grid">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <i class="fas fa-shopping-cart"></i>
                                            <span>今日订单</span>
                                        </div>
                                        <div class="stat-card-content">
                                            <div class="stat-value">142</div>
                                            <div class="stat-label">较昨日 +12%</div>
                                            <el-progress :percentage="65" color="#4caf50"></el-progress>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <i class="fas fa-clock"></i>
                                            <span>待处理订单</span>
                                        </div>
                                        <div class="stat-card-content">
                                            <div class="stat-value">28</div>
                                            <div class="stat-label">等待分配无人机</div>
                                            <el-progress :percentage="85" color="#4caf50"></el-progress>
                                        </div>
                                    </div>
                                </div>

                                <div class="section-title">
                                    <i class="fas fa-list"></i>
                                    最新订单
                                </div>
                                <el-table :data="gridData1">
                                    <el-table-column width="150" property="id" label="订单号"></el-table-column>
                                    <el-table-column width="100" property="name" label="姓名"></el-table-column>
                                    <el-table-column width="150" property="product" label="产品"></el-table-column>
                                    <el-table-column width="150" property="amount" label="价格"></el-table-column>
                                    <el-table-column width="300" property="address" label="地址"></el-table-column>
                                    <el-table-column width="150" property="status" label="配送状态"></el-table-column>
                                </el-table>
                                <el-button slot="reference"><i class="fas fa-shopping-cart"></i>接受消费者订单</el-button>
                            </el-popover>
                        </el-menu-item>

                        <el-menu-item index="1-2">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="card-grid">
                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <i class="fas fa-helicopter"></i>
                                            <span>可用无人机</span>
                                        </div>
                                        <div class="stat-card-content">
                                            <div class="stat-value">8</div>
                                            <div class="stat-label">空闲/总数: 8/12</div>
                                        </div>
                                    </div>

                                    <div class="stat-card">
                                        <div class="stat-card-header">
                                            <i class="fas fa-box"></i>
                                            <span>待分配订单</span>
                                        </div>
                                        <div class="stat-card-content">
                                            <div class="stat-value">28</div>
                                            <div class="stat-label">等待分配</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="section-title">
                                    <i class="fas fa-tasks"></i>
                                    订单匹配建议
                                </div>
                                <div class="drone-card">
                                    <div class="drone-header">
                                        <div class="drone-title">订单 #ORD-20230618002</div>
                                        <div class="drone-status">待分配</div>
                                    </div>
                                    <div class="drone-content">
                                        <div>李女士 - 新鲜水果礼盒</div>
                                        <div>建议无人机: Drone-03</div>
                                    </div>
                                </div>
                                <div class="drone-card">
                                    <div class="drone-header">
                                        <div class="drone-title">订单 #ORD-20230618004</div>
                                        <div class="drone-status">待分配</div>
                                    </div>
                                    <div class="drone-content">
                                        <div>陈女士 - 有机大米10kg</div>
                                        <div>建议无人机: Drone-07</div>
                                    </div>
                                </div>

                                <el-button slot="reference"><i class="fas fa-helicopter"></i>匹配至无人机</el-button>
                            </el-popover>

                        </el-menu-item>
                    </el-submenu>

                    <el-submenu index="2">
                        <template slot="title">
                            <i class="fas fa-route"></i>
                            <span><b>路径规划与优化</b></span>
                        </template>
                        <el-menu-item index="2-1-1">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-road"></i>
                                        最短距离路径规划
                                    </div>

                                    <div class="card-grid">
                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-route"></i>
                                                <span>当前路径</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">18.6 km</div>
                                                <div class="stat-label">预计时间: 42分钟</div>
                                            </div>
                                        </div>

                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-bolt"></i>
                                                <span>节省距离</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">3.2 km</div>
                                                <div class="stat-label">相比普通路线</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-title">
                                        <i class="fas fa-map-marked-alt"></i>
                                        路径详情
                                    </div>

                                    <div id="directions-container">
                                        <h3>配送路线规划</h3>
                                        <p>起点: 农产品仓库</p>
                                        <p>终点: 科技园区A座</p>
                                        <p>途经点: 花园小区、创业大厦</p>
                                        <p>总距离: 18.6公里</p>
                                        <p>预计时间: 42分钟</p>
                                    </div>
                                </div>
                                <el-button slot="reference"><i class="fas fa-road"></i>最短距离</el-button>
                            </el-popover>

                        </el-menu-item>
                        <el-menu-item index="2-1-2">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-dollar-sign"></i>
                                        最低成本路径规划
                                    </div>

                                    <div class="card-grid">
                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-money-bill-wave"></i>
                                                <span>预计成本</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">¥86.50</div>
                                                <div class="stat-label">电力+维护成本</div>
                                            </div>
                                        </div>

                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-percentage"></i>
                                                <span>成本节省</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">23%</div>
                                                <div class="stat-label">相比普通路线</div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                                <el-button slot="reference"><i class="fas fa-dollar-sign"></i>最低成本</el-button>
                            </el-popover>

                        </el-menu-item>
                    </el-submenu>



                    <el-submenu index="4">
                        <template slot="title">
                            <i class="fas fa-exclamation-triangle"></i>
                            <span><b>异常预警与处理</b></span>
                        </template>
                        <el-menu-item index="4-1">

                            <el-popover placement="right" width="400" trigger="click">

                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-wrench"></i>
                                        无人机故障监测
                                    </div>

                                    <div class="alert-card">
                                        <div class="alert-header">
                                            <i class="fas fa-exclamation-circle alert-icon"></i>
                                            <strong>当前故障无人机: 0台</strong>
                                        </div>
                                        <p>所有无人机运行状态良好，无故障报告</p>
                                    </div>

                                    <div class="section-title">
                                        <i class="fas fa-history"></i>
                                        历史故障记录
                                    </div>

                                    <el-table :data="faultHistory" style="width: 100%">
                                        <el-table-column prop="date" label="日期" width="120"></el-table-column>
                                        <el-table-column prop="drone" label="无人机ID" width="120"></el-table-column>
                                        <el-table-column prop="issue" label="故障类型"></el-table-column>
                                        <el-table-column prop="duration" label="处理时间" width="120"></el-table-column>
                                        <el-table-column label="状态" width="100">
                                            <template>
                                                <el-tag type="success">已修复</el-tag>
                                            </template>
                                        </el-table-column>
                                    </el-table>
                                </div>
                                <el-button slot="reference"><i class="fas fa-wrench"></i>监测无人机故障</el-button>
                            </el-popover>
                        </el-menu-item>

                        <el-menu-item index="4-3">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-history"></i>
                                        备用方案管理
                                    </div>

                                    <div class="alert-card">
                                        <div class="alert-header">
                                            <i class="fas fa-info-circle alert-icon"></i>
                                            <strong>当前备用无人机: 3台</strong>
                                        </div>
                                        <p>备用无人机已准备就绪，随时可投入配送</p>
                                    </div>

                                    <div class="section-title">
                                        <i class="fas fa-helicopter"></i>
                                        备用无人机列表
                                    </div>

                                    <el-table :data="backupDrones" style="width: 100%">
                                        <el-table-column prop="id" label="无人机ID" width="120"></el-table-column>
                                        <el-table-column prop="type" label="型号" width="120"></el-table-column>
                                        <el-table-column prop="capacity" label="载重能力" width="120"></el-table-column>
                                        <el-table-column prop="battery" label="电量">
                                            <template slot-scope="scope">
                                                <el-progress :percentage="scope.row.battery"
                                                             :color="batteryColor(scope.row.battery)"></el-progress>
                                            </template>
                                        </el-table-column>
                                        <el-table-column label="状态" width="100">
                                            <template>
                                                <el-tag type="success">待命</el-tag>
                                            </template>
                                        </el-table-column>
                                    </el-table>

                                    <div class="section-title" style="margin-top:30px;">
                                        <i class="fas fa-lightbulb"></i>
                                        应急预案
                                    </div>

                                    <div class="drone-card">
                                        <div class="drone-header">
                                            <div class="drone-title">天气突变应急方案</div>
                                        </div>
                                        <div class="drone-content">
                                            <div>启用备用路线 | 降低飞行高度 | 缩短单次配送距离</div>
                                        </div>
                                    </div>

                                    <div class="drone-card">
                                        <div class="drone-header">
                                            <div class="drone-title">无人机故障应急方案</div>
                                        </div>
                                        <div class="drone-content">
                                            <div>启动备用无人机 | 重新分配任务 | 通知维护团队</div>
                                        </div>
                                    </div>
                                </div>
                                <el-button slot="reference"><i class="fas fa-history"></i>备用方案</el-button>
                            </el-popover>

                        </el-menu-item>
                    </el-submenu>

                    <el-submenu index="5">
                        <template slot="title">
                            <i class="fas fa-chart-bar"></i>
                            <span><b>数据分析与报表生成</b></span>
                        </template>
                        <el-menu-item index="5-1">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-percentage"></i>
                                        订单完成率分析
                                    </div>

                                    <div class="card-grid">
                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-check-circle"></i>
                                                <span>总完成率</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">98.2%</div>
                                                <div class="stat-label">过去30天</div>
                                            </div>
                                        </div>

                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-tachometer-alt"></i>
                                                <span>今日完成率</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">96.5%</div>
                                                <div class="stat-label">已完成/总数: 137/142</div>
                                            </div>
                                        </div>
                                    </div>

                                </div>

                                <el-button slot="reference"><i class="fas fa-percentage"></i>订单完成率</el-button>
                            </el-popover>

                        </el-menu-item>

                        <el-menu-item index="5-3">

                            <el-popover placement="right" width="400" trigger="click">
                                <div class="content-card">
                                    <div class="section-title">
                                        <i class="fas fa-chart-line"></i>
                                        无人机利用率分析
                                    </div>

                                    <div class="card-grid">
                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-helicopter"></i>
                                                <span>平均利用率</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">78.4%</div>
                                                <div class="stat-label">过去7天</div>
                                            </div>
                                        </div>

                                        <div class="stat-card">
                                            <div class="stat-card-header">
                                                <i class="fas fa-calendar-day"></i>
                                                <span>今日利用率</span>
                                            </div>
                                            <div class="stat-card-content">
                                                <div class="stat-value">82.6%</div>
                                                <div class="stat-label">高于平均值</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="section-title">
                                        <i class="fas fa-chart-bar"></i>
                                        各无人机利用率
                                    </div>

                                    <div class="chart-container">
                                        <div class="utilization-chart">
                                            <div class="chart-bar" :style="{ height: '85%' }">
                                                <div class="chart-value">85%</div>
                                                <div class="chart-label">Drone-01</div>
                                            </div>
                                            <div class="chart-bar" :style="{ height: '72%' }">
                                                <div class="chart-value">72%</div>
                                                <div class="chart-label">Drone-02</div>
                                            </div>
                                            <div class="chart-bar" :style="{ height: '91%' }">
                                                <div class="chart-value">91%</div>
                                                <div class="chart-label">Drone-03</div>
                                            </div>
                                            <div class="chart-bar" :style="{ height: '65%' }">
                                                <div class="chart-value">65%</div>
                                                <div class="chart-label">Drone-04</div>
                                            </div>
                                            <div class="chart-bar" :style="{ height: '78%' }">
                                                <div class="chart-value">78%</div>
                                                <div class="chart-label">Drone-05</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <el-button slot="reference"><i class="fas fa-chart-line"></i>无人机利用率</el-button>
                            </el-popover>

                        </el-menu-item>
                    </el-submenu>
                </el-menu>
            </el-aside>


            <el-main style="padding:0;position:relative;">
                <div id="container" style="width:100%; height:100%;">

                </div>
            </el-main>
        </el-container>
    </main>
</div>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
<script src="https://unpkg.com/element-ui/lib/index.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
    new Vue({
        el: '#app',
        data() {
            return {
                activeIndex: '1-1',
                activePanel: '1-1',
                baiduMap: null, // 添加地图实例引用
                gridData1: [
                    { id: '#ORD-20230618001', customer: '张先生', product: '有机蔬菜套餐', amount: '¥128.00', address: '科技园区A座12楼', status: '配送中'},
                    { id: '#ORD-20230618002', customer: '李女士', product: '新鲜水果礼盒', amount: '¥98.00', address: '花园小区3栋502', status: '待分配'},
                    { id: '#ORD-20230618003', customer: '王先生', product: '土鸡蛋x2盒', amount: '¥56.00', address: '创业大厦B座8楼', status: '配送中'},
                    { id: '#ORD-20230618004', customer: '陈女士', product: '有机大米10kg', amount: '¥168.00', address: '阳光小区7栋1203', status: '待分配'}
                ],
                faultHistory: [
                    { date: '2023-06-15', drone: 'Drone-07', issue: '电池接触不良', duration: '2小时' },
                    { date: '2023-06-10', drone: 'Drone-03', issue: 'GPS信号丢失', duration: '1.5小时' },
                    { date: '2023-06-05', drone: 'Drone-11', issue: '螺旋桨损坏', duration: '4小时' }
                ],
                backupDrones: [
                    { id: 'Drone-B01', type: 'AG-X3', capacity: '5kg', battery: 100 },
                    { id: 'Drone-B02', type: 'AG-X2', capacity: '3kg', battery: 95 },
                    { id: 'Drone-B03', type: 'AG-X3', capacity: '5kg', battery: 100 }
                ],

                droneStations: [
                    { id: 'station1', name: '主调度中心', point: { lng: 121.663611, lat: 39.061667} },
                    { id: 'station2', name: '北区调度点', point: { lng: 121.755278, lat: 39.172778 } },
                    { id: 'station3', name: '西区调度点', point: { lng: 121.150398, lat: 38.877143 } },
                    { id: 'station4', name: '南区调度点', point: { lng: 121.293944, lat: 38.825244 } }
                ],
                // 预设固定路线
                presetRoutes: [
                    {
                        id: 'route1',
                        name: '路线1: 西部配送',
                        points: [
                            { lng: 121.150398, lat: 38.877143 }, // 与西区调度点坐标一致
                            { lng: 121.127331, lat: 38.874836 }, // 途经点1：董家沟渔湾
                            { lng: 121.159125, lat: 38.856437 }, // 途经点2：香海金鼎6期
                            { lng: 121.150398, lat: 38.877143 }  // 返回西区调度中心
                        ]
                    }
                ],
                droneIcons: {},  // 存储无人机图标
                currentDronePath: [],  // 当前无人机飞行路径
                dronePosition: null,   // 无人机当前位置
                isDroneMoving: false,  // 无人机是否正在移动
                animationInterval: null, // 动画定时器
                currentDroneIndex: 0   // 当前使用的无人机索引

            };
        },
        mounted() {
            this.initMap();
            // 监听窗口大小变化，重新初始化地图或调整大小
            window.addEventListener('resize', this.onResize);
        },
        beforeDestroy() {
            // 组件销毁前移除事件监听
            window.removeEventListener('resize', this.onResize);

            // 移除地图resize监听
            if (this.baiduMap) {
                this.baiduMap.removeEventListener('resize', () => {
                    const panel = document.querySelector('.drone-route-panel');
                    if (panel) panel.style.bottom = '15px';
                });
            }

        },
        methods: {
            handleMenuSelect(index) {
                // 如果点击的是当前已激活的面板，则关闭它
                if (this.activePanel === index) {
                    this.activePanel = null;
                } else {
                    this.activePanel = index;
                }
            },

            closePanel() {
                this.activePanel = null;
            },

            onResize() {
                // 当窗口大小改变时，重新初始化地图以适应新的容器尺寸
                this.initMap();
            },

            initMap() {
                // 确保DOM已经渲染完成
                this.$nextTick(() => {
                    // 检查地图容器是否存在
                    const container = document.getElementById('container');
                    if (!container) {
                        console.error('地图容器不存在');
                        return;
                    }

                    // 初始化地图
                    const map = new BMapGL.Map("container");
                    // 调整中心点以更好地展示大连全貌
                    const point = new BMapGL.Point(121.550000, 38.950000);
                    map.centerAndZoom(point, 11);


                    map.addEventListener("resize", function(){
                        var panel = document.querySelector(".drone-route-panel");
                        if(panel) panel.style.bottom = "50px"; // 动态调整底部间距
                    });

                    // 启用滚轮缩放
                    map.enableScrollWheelZoom(true);

                    // 添加控件
                    map.addControl(new BMapGL.ScaleControl());
                    map.addControl(new BMapGL.ZoomControl());
                    map.addControl(new BMapGL.NavigationControl());

                    // 设置地图样式（可选）
                    map.setMapStyleV2({
                        styleId: 'c43d47d1a166090a6b5a05ff15a9c2c3' // 清新蓝风格
                    });

                    // 添加标记点 (仓库)
                    const marker = new BMapGL.Marker(new BMapGL.Point(121.620000, 38.920000));
                    map.addOverlay(marker);

                    // 信息窗口
                    const infoWindow = new BMapGL.InfoWindow("智农通农产品仓库");
                    marker.addEventListener('click', function() {
                        map.openInfoWindow(infoWindow, marker.getPosition());
                    });

                    /**
                     * =========================================
                     * 新增：多种类禁飞区绘制 (按照要求修改)
                     * =========================================
                     */

                        // 定义不同类型的禁飞区数据
                    const noFlyZonesData = [
                            {
                                type: 'airport',
                                name: '大连周水子国际机场 (核心禁飞区)',
                                color: '#e52424', // 黄色 - 机场
                                desc: '机场净空保护区，包含跑道及起降航线覆盖范围',
                                points: [
                                    // 模拟机场禁飞区形状：中间窄（跑道），两头宽（进近面），呈不规则多边形
                                    new BMapGL.Point(121.400, 38.990),
                                    new BMapGL.Point(121.490, 38.975),
                                    new BMapGL.Point(121.510, 38.990),
                                    new BMapGL.Point(121.530, 39.000),
                                    new BMapGL.Point(121.550, 39.001),
                                    new BMapGL.Point(121.580, 38.990),
                                    new BMapGL.Point(121.595, 38.980),
                                    new BMapGL.Point(121.680, 39.005),
                                    new BMapGL.Point(121.685, 38.940),
                                    new BMapGL.Point(121.595, 38.955),
                                    new BMapGL.Point(121.575, 38.940),
                                    new BMapGL.Point(121.555, 38.930),
                                    new BMapGL.Point(121.535, 38.929),
                                    new BMapGL.Point(121.510, 38.940),
                                    new BMapGL.Point(121.495, 38.950),
                                    new BMapGL.Point(121.405, 38.925)
                                ]
                            },
                            {
                                type: 'military',
                                name: '军事管理禁区 (旅顺方向)',
                                color: '#FF0000', // 红色 - 军事区
                                desc: '军事敏感区域，严禁无人机靠近',
                                points: [
                                    new BMapGL.Point(121.230, 38.830),
                                    new BMapGL.Point(121.280, 38.830),
                                    new BMapGL.Point(121.280, 38.790),
                                    new BMapGL.Point(121.250, 38.780),
                                    new BMapGL.Point(121.230, 38.800)
                                ]
                            },
                            {
                                type: 'port',
                                name: '大连港口作业区',
                                color: '#0000FF', // 蓝色 - 港口
                                desc: '繁忙港口作业区，低空飞行危险',
                                points: [
                                    new BMapGL.Point(121.650, 38.940),
                                    new BMapGL.Point(121.690, 38.940),
                                    new BMapGL.Point(121.685, 38.920),
                                    new BMapGL.Point(121.655, 38.925)
                                ]
                            },
                            {
                                type: 'chemical',
                                name: '大孤山化工区 (危险品)',
                                color: '#FFA500', // 橙色 - 化工/能源
                                desc: '易燃易爆危险品区域，禁飞',
                                points: [
                                    new BMapGL.Point(121.720, 39.010),
                                    new BMapGL.Point(121.760, 39.010),
                                    new BMapGL.Point(121.760, 38.980),
                                    new BMapGL.Point(121.720, 38.980)
                                ]
                            },
                            {
                                type: 'gov',
                                name: '星海广场核心管控区',
                                color: '#FF0000', // 红色 - 重点区域
                                desc: '人流密集及重大活动区域临时管控',
                                points: [
                                    new BMapGL.Point(121.580, 38.885),
                                    new BMapGL.Point(121.595, 38.885),
                                    new BMapGL.Point(121.595, 38.875),
                                    new BMapGL.Point(121.580, 38.875)
                                ]
                            }
                        ];

                    // 循环绘制禁飞区
                    noFlyZonesData.forEach(zone => {
                        // 创建多边形
                        const polygon = new BMapGL.Polygon(zone.points, {
                            strokeColor: zone.color,    // 边框颜色
                            strokeWeight: 2,
                            strokeOpacity: 0.8,
                            fillColor: zone.color,      // 填充颜色
                            fillOpacity: 0.3            // 半透明填充
                        });

                        map.addOverlay(polygon);

                        // 添加点击事件
                        polygon.addEventListener('click', function(e) {
                            const infoContent = `
                                <div style="padding:5px;">
                                    <h4 style="margin:0 0 5px 0; color:${zone.color}">${zone.name}</h4>
                                    <p style="margin:0; font-size:13px; color:#666;">${zone.desc}</p>
                                    <p style="margin:5px 0 0 0; font-size:12px; color:#999;">限制高度: 0m (全禁)</p>
                                </div>
                            `;
                            const infoWindow = new BMapGL.InfoWindow(infoContent);
                            map.openInfoWindow(infoWindow, e.point);
                        });

                        // 计算多边形中心点用于放置标签
                        let latSum = 0, lngSum = 0;
                        zone.points.forEach(p => {
                            latSum += p.lat;
                            lngSum += p.lng;
                        });
                        const center = new BMapGL.Point(lngSum / zone.points.length, latSum / zone.points.length);

                        // 添加文字标签
                        const label = new BMapGL.Label("NO FLY", {
                            position: center,
                            offset: new BMapGL.Size(-20, -10)
                        });
                        label.setStyle({
                            color: zone.color,
                            fontSize: "10px",
                            fontWeight: "bold",
                            border: `1px solid ${zone.color}`,
                            borderRadius: "2px",
                            backgroundColor: "rgba(255,255,255,0.8)",
                            padding: "0 4px",
                            textAlign: "center"
                        });
                        map.addOverlay(label);
                    });

                    // 添加图例控件 (使用自定义Control或直接DOM添加)
                    // 为了简单起见，我们直接创建一个DOM元素并添加到map容器中
                    // 注意：因为地图可能会重绘，我们在Vue mounted中添加一次即可，或者作为覆盖物

                    // 这里我们创建一个自定义控件类来添加图例，这样更符合百度地图API规范
                    function LegendControl() {
                        this.defaultAnchor = BMAP_ANCHOR_BOTTOM_RIGHT;
                        this.defaultOffset = new BMapGL.Size(20, 20);
                    }

                    // 继承Control的JS API写法在BMapGL中略有不同，
                    // 为了兼容性和简便，我们直接追加HTML到容器
                    // 如果已经存在则移除
                    const existingLegend = document.querySelector('.map-legend');
                    if(existingLegend) existingLegend.remove();

                    const legendDiv = document.createElement('div');
                    legendDiv.className = 'map-legend';
                    legendDiv.innerHTML = `
                        <h4><i class="fas fa-layer-group"></i> 禁飞区图例</h4>
                        <div class="legend-item">
                            <span class="color-box" style="background: rgba(255, 0, 0, 0.5); border-color: #ff0000"></span>
                            <span>军管/核心区 (禁飞)</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background: rgba(255, 215, 0, 0.5); border-color: #ffd700"></span>
                            <span>机场/净空区 (限高)</span>
                        </div>
                        <div class="legend-item">
                            <span class="color-box" style="background: rgba(0, 0, 255, 0.5); border-color: #0000ff"></span>
                            <span>港口/码头 (管控)</span>
                        </div>
                         <div class="legend-item">
                            <span class="color-box" style="background: rgba(255, 165, 0, 0.5); border-color: #ffa500"></span>
                            <span>化工/危险品 (禁飞)</span>
                        </div>
                    `;
                    document.getElementById('container').appendChild(legendDiv);


                    /**
                     * =========================================
                     * 禁飞区绘制结束
                     * =========================================
                     */


                        // 定义无人机图标
                    const droneIcon = new BMapGL.Icon(
                            "data:image/svg+xml;charset=utf-8," +
                            encodeURIComponent(`
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#2196f3">
                                <path d="M12 3L2 12h3v8h14v-8h3L12 3zm5 15h-2v-2H9v2H7v-3L5 17v2h2v2h2v-2h6v2h2v-2h2v-2l-2-2v3h-2zm-3-5a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/>
                            </svg>
                        `),
                            new BMapGL.Size(32, 32)
                        );

                    // 为每个调度点创建图标
                    this.droneStations.forEach((station, index) => {
                        const stationPoint = new BMapGL.Point(station.point.lng, station.point.lat);
                        const marker = new BMapGL.Marker(stationPoint, {
                            icon: new BMapGL.Icon(
                                "data:image/svg+xml;charset=utf-8," +
                                encodeURIComponent(`
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#4caf50">
                                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                                    </svg>
                                `),
                                new BMapGL.Size(28, 28)
                            )
                        });

                        // 添加红色定位标记
                        const pinIcon = new BMapGL.Icon(
                            "data:image/svg+xml;charset=utf-8," +
                            encodeURIComponent(`
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
                                    <path d="M12 2.25c-4.41 0-8 3.59-8 8 0 6.25 8 13.5 8 13.5s8-7.25 8-13.5c0-4.41-3.59-8-8-8zm0 13c-1.65 0-3-1.35-3-3s1.35-3 3-3 3 1.35 3 3-1.35 3-3 3z" fill="#ff0000"/>
                                </svg>
                            `),
                            new BMapGL.Size(16, 16)
                        );

                        // 添加文字标签
                        const label = new BMapGL.Label(station.name, {
                            position: stationPoint,
                            offset: new BMapGL.Size(30, -10)
                        });
                        label.setStyle({
                            color: "#4caf50",
                            fontSize: "14px",
                            fontWeight: "bold",
                            border: "1px solid #4caf50",
                            borderRadius: "4px",
                            backgroundColor: "rgba(255,255,255,0.8)",
                            padding: "2px 6px",
                            textAlign: "center"
                        });
                        map.addOverlay(label);

                        // 添加定位标记，位于文字标签下方
                        const pinMarker = new BMapGL.Marker(stationPoint, {
                            icon: pinIcon,
                            offset: new BMapGL.Size(0, 15) // 向下偏移15像素
                        });
                        map.addOverlay(pinMarker);

                        // 添加信息窗口
                        const infoWindow = new BMapGL.InfoWindow(`<strong>${station.name}</strong><br/>调度点ID: ${station.id}`);
                        marker.addEventListener('click', () => {
                            map.openInfoWindow(infoWindow, stationPoint);
                        });

                        map.addOverlay(marker);



                        // 为每个调度点创建一个无人机图标
                        this.droneIcons[station.id] = new BMapGL.Marker(stationPoint, {
                            icon: droneIcon,
                            enableDragging: false
                        });
                        map.addOverlay(this.droneIcons[station.id]);
                    });



                    /*************** 在这里添加以下代码 ***************/
                        // 避免航路规划面板与百度地图控件冲突
                    const adjustPanelPosition = () => {
                            try {
                                const scaleControl = document.querySelector('.BMap_scale_control');
                                const panel = document.querySelector('.drone-route-panel');
                                if (scaleControl && panel) {
                                    const scaleHeight = scaleControl.offsetHeight;
                                    panel.style.bottom = (scaleHeight + 20) + 'px';
                                } else if (panel) {
                                    // 如果找不到比例尺控件，使用默认底部位置
                                    panel.style.bottom = '15px';
                                }
                            } catch (error) {
                                console.error('调整面板位置时出错:', error);
                            }
                        };

                    // 监听地图resize事件
                    map.addEventListener('resize', adjustPanelPosition);

                    // 初始化时调整位置
                    setTimeout(adjustPanelPosition, 300);
                    /*************** 添加代码结束 ***************/

                    // 保存地图实例到Vue实例，便于后续使用
                    this.baiduMap = map;

                    /**
                     * 初始化无人机航路规划面板
                     * 必须在地图初始化完成后调用
                     */
                    const initDroneRoutePanel = () => {

                        console.log('正在创建航路规划面板...');
                        console.log('容器是否存在:', document.getElementById('container'));

                        // 1. 创建面板容器
                        const panel = document.createElement('div');
                        panel.className = 'drone-route-panel';
                        panel.style.cssText = `
                            position: absolute;
                            left: 15px;
                            bottom: 15px;
                            width: 320px;
                            background: white;
                            border-radius: 8px;
                            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
                            z-index: 1000;
                            padding: 15px;
                            font-family: 'PingFang SC', 'Microsoft YaHei';
                            transition: all 0.3s ease;
                            display: none;
                          `;

                        // 2. 构建面板内容
                        panel.innerHTML = `
                              <!-- 标题区域 -->
                              <div style="display: flex; align-items: center; margin-bottom: 12px;">
                                <span style="color: #0066cc; font-size: 20px; margin-right: 8px;">✈️</span>
                                <h3 style="margin: 0; font-size: 18px; color: #333;">无人机航行路线规划</h3>
                              </div>

                              <!-- 调度点信息 -->
                              <div style="background: #e8f5e9; padding: 8px; border-radius: 4px; margin-bottom: 12px; font-size: 13px;">
                                <strong>可用调度点: ${this.droneStations.length}个</strong><br/>
                                <span style="color: #4caf50;">✓</span> 系统将自动选择距离起点最近的调度点
                              </div>

                              <!-- 起点选择 -->
                              <div style="margin-bottom: 12px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #555;">搜索起点</label>
                                <div style="display: flex; gap: 8px;">
                                  <input type="text" id="startPoint" placeholder="请输入起点..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                  <button id="searchStart" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 0 10px;">搜索</button>
                                </div>
                              </div>

                              <!-- 终点选择 -->
                              <div style="margin-bottom: 15px;">
                                <label style="display: block; font-weight: 500; margin-bottom: 5px; color: #555;">搜索终点</label>
                                <div style="display: flex; gap: 8px;">
                                  <input type="text" id="endPoint" placeholder="请输入终点..." style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                  <button id="searchEnd" style="background: #0066cc; color: white; border: none; border-radius: 4px; padding: 0 10px;">搜索</button>
                                </div>
                              </div>

                              <!-- 操作按钮 -->
                              <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button id="clearRoute" style="flex: 1; background: #f1f3f5; color: #333; border: 1px solid #ddd; border-radius: 4px; padding: 8px;">清除选择</button>
                                <button id="calculateRoute" style="flex: 1; background: #2e7d32; color: white; border: none; border-radius: 4px; padding: 8px;">确定路径</button>
                              </div>

                              <!-- 高度设置 -->
                              <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #eee;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                  <span style="font-size: 12px; color: #666;">设置飞行高度</span>
                                  <span style="font-size: 12px; color: #0066cc;" id="heightValue">50 米</span>
                                </div>
                                <input type="range" id="flightHeight" min="10" max="200" value="50" style="width: 100%;">
                              </div>

                              <!-- 飞行状态显示 -->
                              <div id="flightStatus" style="margin-top: 10px; padding: 8px; background: #e3f2fd; border-radius: 4px; font-size: 13px; display: none; border: 1px solid #bbdefb;">
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong>当前状态:</strong>
                                    <span id="statusText" style="color: #1976d2;">准备就绪</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong>当前位置:</strong>
                                    <span id="positionText" style="color: #1976d2;">调度点</span>
                                </div>
                                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                    <strong>飞行高度:</strong>
                                    <span id="currentHeight" style="color: #1976d2;">50</span> 米
                                </div>
                                <div style="display: flex; justify-content: space-between;">
                                    <strong>进度:</strong>
                                    <span id="progressText" style="color: #1976d2;">0%</span>
                                </div>
                            </div>
                            `;

                        // 3. 添加到地图容器
                        const mapContainer = document.getElementById('container');
                        if (mapContainer) {
                            mapContainer.appendChild(panel);
                            console.log('航路规划面板创建完成');

                            // 直接显示面板，不再使用复杂的延迟
                            panel.style.display = 'block';
                            panel.style.opacity = '1';
                        } else {
                            console.error('地图容器不存在，无法添加航路规划面板');
                            return;
                        }

                        // 4. 添加交互功能
                        panel.style.display = 'block';

                        try {
                            // 5. 为按钮添加事件监听
                            panel.querySelector('#searchStart').addEventListener('click', function() {
                                const start = panel.querySelector('#startPoint').value;
                                if (start) {
                                    alert(`已设置起点: ${start}`);
                                    // 这里添加百度地图标记起点的代码
                                }
                            });
                        } catch (error) {
                            console.error('设置事件监听器时出错:', error);
                            alert('部分功能不可用，但面板已加载');
                        }


                        panel.querySelector('#searchEnd').addEventListener('click', function() {
                            const end = panel.querySelector('#endPoint').value;
                            if (end) {
                                alert(`已设置终点: ${end}`);
                                // 这里添加百度地图标记终点的代码
                            }
                        });

                        // 保存Vue实例引用
                        const self = this;

                        // 为按钮添加事件监听
                        panel.querySelector('#calculateRoute').addEventListener('click', function() {
                            // 停止之前的动画
                            if (self.animationInterval) {
                                clearInterval(self.animationInterval);
                                self.isDroneMoving = false;
                            }

                            // 保存当前所有覆盖物（不包括路线）
                            const overlays = self.baiduMap.getOverlays();
                            const toKeep = overlays.filter(overlay =>
                                !(overlay instanceof BMapGL.Polyline || overlay instanceof BMapGL.Marker)
                            );

                            // 清除所有覆盖物
                            self.baiduMap.clearOverlays();

                            // 重新添加需要保留的覆盖物（调度点等）
                            toKeep.forEach(overlay => self.baiduMap.addOverlay(overlay));

                            // 重新添加调度点和无人机图标
                            self.droneStations.forEach(station => {
                                const stationPoint = new BMapGL.Point(station.point.lng, station.point.lat);

                                // 重新添加调度点标记
                                const stationMarker = new BMapGL.Marker(stationPoint, {
                                    icon: new BMapGL.Icon(
                                        "data:image/svg+xml;charset=utf-8," +
                                        encodeURIComponent(`
                                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="#4caf50">
                                                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z"/>
                                            </svg>
                                        `),
                                        new BMapGL.Size(28, 28)
                                    )
                                });
                                self.baiduMap.addOverlay(stationMarker);

                                // 重新添加无人机图标
                                if (self.droneIcons[station.id]) {
                                    self.droneIcons[station.id].setPosition(stationPoint);
                                    self.baiduMap.addOverlay(self.droneIcons[station.id]);
                                }
                            });

                            // 始终选择第一条预设路线
                            const selectedRoute = self.presetRoutes[0];

                            // 修复：直接使用原始坐标创建点
                            const pathPoints = selectedRoute.points.map(point =>
                                new BMapGL.Point(point.lng, point.lat)
                            );

                            // 保存当前路径
                            self.currentDronePath = pathPoints;

                            // 选择使用西区调度点的无人机
                            self.currentStation = self.droneStations.find(s => s.id === 'station3');
                            const droneMarker = self.droneIcons[self.currentStation.id];

                            // 将无人机移动到起始位置
                            droneMarker.setPosition(pathPoints[0]);

                            // 绘制路径
                            const routePolyline = new BMapGL.Polyline(pathPoints, {
                                strokeColor: "#18a45b",
                                strokeWeight: 4,
                                strokeOpacity: 0.8
                            });
                            self.baiduMap.addOverlay(routePolyline);

                            // 添加路径标记点
                            pathPoints.forEach((point, index) => {
                                if (index === 0 || index === pathPoints.length - 1 || index === Math.floor(pathPoints.length/2)) {
                                    const marker = new BMapGL.Marker(point, {
                                        icon: new BMapGL.Icon(
                                            "data:image/svg+xml;charset=utf-8," +
                                            encodeURIComponent(`
                                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" fill="${index === 0 ? '#ff5722' : (index === pathPoints.length-1 ? '#e91e63' : '#2196f3')}">
                                                    <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
                                                </svg>
                                            `),
                                            new BMapGL.Size(24, 24)
                                        )
                                    });

                                    const infoContent = index === 0 ? "起点: 西区调度中心" :
                                        (index === pathPoints.length-1 ? "终点: 返回西区调度中心" : `途经点 ${index}`);
                                    const infoWindow = new BMapGL.InfoWindow(infoContent);

                                    marker.addEventListener('click', function() {
                                        self.baiduMap.openInfoWindow(infoWindow, point);
                                    });

                                    self.baiduMap.addOverlay(marker);
                                }
                            });


                            // 直接设置中心点和缩放级别
                            const targetPoint = new BMapGL.Point(121.159125, 38.876437);
                            self.baiduMap.centerAndZoom(targetPoint, 15); // 这个方法同时设置中心和缩放

                            // 显示飞行按钮
                            let flightBtn = panel.querySelector('#flightBtn');
                            if (!flightBtn) {
                                flightBtn = document.createElement('button');
                                flightBtn.id = 'flightBtn';
                                flightBtn.style.cssText = `
                                    width: 100%;
                                    background: #ff9800;
                                    color: white;
                                    border: none;
                                    border-radius: 4px;
                                    padding: 10px;
                                    margin-top: 10px;
                                    font-weight: bold;
                                    cursor: pointer;
                                `;
                                flightBtn.innerHTML = '✈️ 开始配送';
                                panel.appendChild(flightBtn);
                                flightBtn.addEventListener('click', function() {
                                    if (!self.isDroneMoving) {
                                        self.moveDroneAlongPath();
                                        this.innerHTML = '⏸ 暂停配送';
                                    } else {
                                        clearInterval(self.animationInterval);
                                        self.isDroneMoving = false;
                                        this.innerHTML = '✈️ 继续配送';
                                    }
                                });
                            } else {
                                flightBtn.style.display = 'block';
                                flightBtn.innerHTML = '✈️ 开始配送';
                            }

                            alert(`已加载预设路线: ${selectedRoute.name}\n点击"开始配送"按钮启动无人机`);
                        });

                        panel.querySelector('#clearRoute').addEventListener('click', function() {
                            panel.querySelector('#startPoint').value = '';
                            panel.querySelector('#endPoint').value = '';

                            // 停止无人机移动
                            if (self.animationInterval) {
                                clearInterval(self.animationInterval);
                                self.isDroneMoving = false;
                            }

                            // 隐藏飞行按钮
                            const flightBtn = panel.querySelector('#flightBtn');
                            if (flightBtn) {
                                flightBtn.style.display = 'none';
                            }

                            // 重置无人机到各自调度点
                            self.droneStations.forEach(station => {
                                if (self.droneIcons[station.id]) {
                                    const stationPoint = new BMapGL.Point(station.point.lng, station.point.lat);
                                    self.droneIcons[station.id].setPosition(stationPoint);
                                }
                            });

                            // 重新初始化地图
                            self.initMap();
                            alert('已清除路径规划并重置无人机位置');
                        });

                        panel.querySelector('#flightHeight').addEventListener('input', function() {
                            const height = this.value;
                            panel.querySelector('#heightValue').textContent = `${height} 米`;
                            // 这里可以添加高度变化时的处理逻辑
                        });

                        // 6. 处理地图缩放时的位置调整
                        map.addEventListener('resize', function() {
                            // 确保面板不被百度地图控件覆盖
                            const scaleControl = document.querySelector('.BMap_scale_control');
                            if (scaleControl) {
                                const scaleHeight = scaleControl.offsetHeight;
                                panel.style.bottom = (scaleHeight + 20) + 'px';
                            }
                        });

                        // 7. 初始化时调整位置（避免与比例尺重叠）
                        setTimeout(() => {
                            panel.style.display = 'block';
                            panel.style.opacity = '1';

                            // 添加必要的空检查
                            if (panel.querySelector('#flightStatus')) {
                                panel.querySelector('#flightStatus').style.display = 'none';
                            }
                        }, 300);

                        console.log('航路规划面板创建完成');
                    };

                    // 创建面板
                    initDroneRoutePanel();

                });
            },

            // 计算距离最近的调度点
            findNearestStation(point) {
                let nearestStation = null;
                let minDistance = Infinity;

                this.droneStations.forEach(station => {
                    const stationPoint = new BMapGL.Point(station.point.lng, station.point.lat);
                    const distance = this.baiduMap.getDistance(stationPoint, point);

                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStation = station;
                    }
                });

                return nearestStation;
            },

            // 计算两点之间的路线点
            calculatePathPoints(startPoint, endPoint, steps = 50) {
                const pathPoints = [];
                const lngStep = (endPoint.lng - startPoint.lng) / steps;
                const latStep = (endPoint.lat - startPoint.lat) / steps;

                for (let i = 0; i <= steps; i++) {
                    pathPoints.push(new BMapGL.Point(
                        startPoint.lng + lngStep * i,
                        startPoint.lat + latStep * i
                    ));
                }

                return pathPoints;
            },

            // 计算两点之间的角度（用于无人机方向）
            calculateAngle(point1, point2) {
                const dx = point2.lng - point1.lng;
                const dy = point2.lat - point1.lat;
                let angle = Math.atan2(dy, dx) * (180 / Math.PI);
                // 调整角度，使0度指向北方
                angle = 90 - angle;
                return angle;
            },

            // 更新无人机图标旋转
            updateDroneRotation(marker, angle) {
                const rotatedIcon = new BMapGL.Icon(
                    "data:image/svg+xml;charset=utf-8," +
                    encodeURIComponent(`
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24" transform="rotate(${angle} 12 12)" fill="#2196f3">
                            <path d="M12 3L2 12h3v8h14v-8h3L12 3zm5 15h-2v-2H9v2H7v-3L5 17v2h2v2h2v-2h6v2h2v-2h2v-2l-2-2v3h-2zm-3-5a2 2 0 1 1-4 0 2 2 0 0 1 4 0z"/>
                        </svg>
                    `),
                    new BMapGL.Size(32, 32)
                );
                marker.setIcon(rotatedIcon);
            },

            // 移动无人机
            moveDroneAlongPath() {
                if (!this.currentDronePath || this.currentDronePath.length === 0) return;
                let currentIndex = 0;
                const droneMarker = this.droneIcons[this.currentStation.id];

                // 检查路径段信息是否已定义
                if (!this.pathSegments) {
                    this.pathSegments = {
                        toStart: Math.floor(this.currentDronePath.length / 3),
                        toEnd: Math.floor(this.currentDronePath.length * 2 / 3)
                    };
                }

                // 保存this引用
                const self = this;

                // 清除之前的动画
                if (this.animationInterval) {
                    clearInterval(this.animationInterval);
                }
                this.isDroneMoving = true;

                // 显示飞行状态面板
                const statusPanel = document.querySelector('#flightStatus');
                const statusText = document.querySelector('#statusText');
                const positionText = document.querySelector('#positionText');
                const currentHeight = document.querySelector('#currentHeight');
                if (statusPanel) statusPanel.style.display = 'block';

                // 更新飞行按钮状态
                const flightBtn = document.querySelector('#flightBtn');
                if (flightBtn) {
                    flightBtn.innerHTML = '⏸ 暂停配送';
                    flightBtn.style.background = '#ff9800';
                }

                // 每100ms移动一次
                this.animationInterval = setInterval(() => {
                    if (currentIndex < self.currentDronePath.length) {
                        const point = self.currentDronePath[currentIndex];
                        droneMarker.setPosition(point);

                        // 计算并设置无人机方向
                        if (currentIndex > 0) {
                            const prevPoint = self.currentDronePath[currentIndex - 1];
                            const angle = self.calculateAngle(prevPoint, point);
                            self.updateDroneRotation(droneMarker, angle);
                        }

                        // 更新状态显示
                        if (statusText) {
                            if (currentIndex < self.pathSegments.toStart) {
                                statusText.textContent = '前往起点';
                            } else if (currentIndex < self.pathSegments.toEnd) {
                                statusText.textContent = '配送中';
                            } else {
                                statusText.textContent = '返回调度点';
                            }
                        }

                        if (positionText) {
                            positionText.textContent = `经度: ${point.lng.toFixed(5)}, 纬度: ${point.lat.toFixed(5)}`;
                        }

                        if (currentHeight) {
                            const heightSlider = document.querySelector('#flightHeight');
                            currentHeight.textContent = heightSlider ? heightSlider.value : '50';
                        }

                        currentIndex++;
                    } else {
                        // 路径完成处理
                        clearInterval(self.animationInterval);
                        self.isDroneMoving = false;

                        if (statusText) {
                            statusText.textContent = '任务完成';
                        }

                        if (flightBtn) {
                            flightBtn.innerHTML = '✈️ 重新开始';
                            flightBtn.style.background = '#4CAF50';
                        }

                        // 2秒后重置状态
                        setTimeout(() => {
                            if (statusPanel) statusPanel.style.display = 'none';
                        }, 2000);
                    }
                    const progressText = document.querySelector('#progressText');
                    if (progressText) {
                        const progress = Math.round((currentIndex / self.currentDronePath.length) * 100);
                        progressText.textContent = `${progress}%`;
                    }
                }, 100);
            },
            // 添加电池颜色计算方法
            batteryColor(percentage) {
                if (percentage < 30) return '#f44336'; // 红色 - 低电量
                if (percentage < 70) return '#ffa000'; // 橙色 - 中等电量
                return '#4caf50'; // 绿色 - 高电量
            }
        }
    });


</script>


</body>

</html>